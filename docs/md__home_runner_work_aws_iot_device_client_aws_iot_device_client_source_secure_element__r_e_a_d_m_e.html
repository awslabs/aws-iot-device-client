<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device Client: Provisioning with Secure Elements (HSM/TPM)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device Client
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Provisioning with Secure Elements (HSM/TPM) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Notice:</b> Running the AWS IoT Device Client will incur usage of AWS IoT services, and is likely to incur charges on your AWS account. Please refer the pricing pages for <a href="https://aws.amazon.com/iot-core/pricing/">AWS IoT Core</a>, <a href="https://aws.amazon.com/iot-device-management/pricing/">AWS IoT Device Management</a>, and <a href="https://aws.amazon.com/iot-device-defender/pricing/">AWS IoT Device Defender</a> for more details.</p>
<ul>
<li><a href="#provisioning-with-secure-element-hsmtpm">Provisioning with Secure Elements (HSM/TPM)</a><ul>
<li><a href="#overview">Overview</a><ul>
<li><a href="#fleet-provisioning-with-secured-elements">Fleet Provisioning with Secured Elements</a></li>
<li><a href="#store-private-key-in-security-module">Store Private Key in Security Module</a></li>
<li><a href="#provisioning-with-secure-elements-feature-configuration-options">Provisioning with Secure Elements Feature Configuration Options</a></li>
</ul>
</li>
<li><a href="#building-and-starting-device-client">Building And Starting Device Client</a><ul>
<li><a href="#building-device-client">Building Device Client</a></li>
<li><a href="#configure-softhsm2-and-start-device-client">Configure SoftHSM2 and start Device Client</a></li>
</ul>
</li>
<li><a href="#security-best-practices">Security Best Practices</a></li>
</ul>
</li>
</ul>
<p>*Back To The Main Readme*</p>
<h1><a class="anchor" id="autotoc_md46"></a>
Overview</h1>
<p>The Device Client handles MQTT connectivity with AWS IoT core - it enables your IoT device to automatically connect and make subscriptions to feature-relevant MQTT topics. The client uses combination of certificate and private key registered with AWS IoT for MQTT connectivity with AWS IoT core. The Device Client provides support for private key stored in secure element. It will use PKCS#11 APIs (Cryptoki) to access the private key stored on a PKCS#11 compatible smart card or Hardware Security Module (HSM).</p>
<p>For more details regarding how AWS IoT Device SDK initializes and uses PKCS#11 (Cryptoki) library, refer these documents:</p><ol type="1">
<li><a href="https://aws.github.io/aws-iot-device-sdk-cpp-v2/class_aws_1_1_crt_1_1_io_1_1_tls_context_pkcs11_options.html">TlsContext Pkcs11 Options</a></li>
<li><a href="https://aws.github.io/aws-iot-device-sdk-cpp-v2/class_aws_1_1_crt_1_1_io_1_1_pkcs11_lib.html">Pkcs11Lib Class</a> <br  />
</li>
</ol>
<p><em><b>The minimum version of PKCS#11 API (Cryptoki) library supported by Device Client is v2.20.</b></em></p>
<h2><a class="anchor" id="autotoc_md47"></a>
Fleet Provisioning with Secured Elements</h2>
<p>The AWS IoT Device Client offers the ability to automatically provision your IoT device when you first connect it to AWS IoT Core. The device client provides two different mechanisms for provisioning your device (1) using a claim certificate and private key OR (2) using a Certificate Signing Request (CSR) along with claim certificate and key to securely provision the device while keeping the user private key secure.</p>
<p>When you use Fleet Provisioning with Secure Elements, the AWS IoT Device Client currently only supports the use of Certificate Signing Requests (CSRs). The AWS IoT Device Client does not support writing a new private key to your Secure Element since this is against security best practices.</p>
<p>More details about the Fleet Provisioning feature can be found here: <a class="el" href="md__home_runner_work_aws_iot_device_client_aws_iot_device_client_source_fleetprovisioning__r_e_a_d_m_e.html">Fleet Provisioning Feature README</a></p>
<p><b>Note:</b> In the above-mentioned scenario, the runtime config file will store empty file path for <b>key</b> if no file path is provided.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
Store Private Key in Security Module</h2>
<p>The user is responsible for creating and storing the private key on a PKCS#11 compatible smart card or Hardware Security Module (HSM). The AWS IoT Device Client <b>does not</b> support writing a new private key to your Secure Element since this is against security best practices.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
Provisioning with Secure Elements Feature Configuration Options</h2>
<p>The Provisioning with Secure Elements feature is <b>disabled</b> by default. You can use the JSON config file and/or CLI options to enable/disable the feature.</p>
<p>To get started with the feature you will need to set the right configuration. This consists of three required parameters and three optional parameters</p>
<p><b>Required Parameters:</b></p>
<p><code>enabled</code>: Whether or not the Provisioning with Secure Elements feature is enabled (True/False).</p>
<p><code>pkcs11-lib</code>: Path to PKCS#11 library.</p>
<p><code>secure-element-pin</code>: User PIN for logging into PKCS#11 token.</p>
<p><b>Optional Parameter:</b></p>
<p><code>secure-element-key-label</code>: Label of private key on the PKCS#11 token (optional).</p>
<p><code>secure-element-slot-id</code>: Numeric Slot ID containing PKCS#11 token to use (optional).</p>
<p><code>secure-element-token-label</code>: Label of the PKCS#11 token to use (optional).</p>
<h3><a class="anchor" id="autotoc_md50"></a>
Configuring the Provisioning with Secure Elements feature via the command line</h3>
<div class="fragment"><div class="line">$ ./aws-iot-device-client --enable-secure-element [true|false] --pkcs11-lib [your/path/to/pkcs#11/library] --secure-element-pin [User PIN of PKCS#11 token] --secure-element-key-label [key-label] --secure-element-slot-id [token-slot-id] --secure-element-token-label [token-label]</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md51"></a>
Configuring the Provisioning with Secure Elements feature via the JSON configuration file</h3>
<div class="fragment"><div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    &quot;secure-element&quot;: {</div>
<div class="line">        &quot;enabled&quot;: false,</div>
<div class="line">        &quot;pkcs11-lib&quot;: &quot;&lt;replace_with_pkcs11_lib_path&gt;&quot;,</div>
<div class="line">        &quot;secure-element-pin&quot;: &quot;&lt;replace_with_secure_element_pin&gt;&quot;,</div>
<div class="line">        &quot;secure-element-key-label&quot;: &quot;&lt;replace_with_secure_element_key_label&gt;&quot;,</div>
<div class="line">        &quot;secure-element-slot-id&quot;: replace_with_secure_element_slot_id_integer,</div>
<div class="line">        &quot;secure-element-token-label&quot;: &quot;&lt;replace_with_secure_element_token_label&gt;&quot;</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Note:</b> If Provisioning with Secure Elements feature is disabled, Device Client will look for private key on the file system.</p>
<h1><a class="anchor" id="autotoc_md52"></a>
Building And Starting Device Client</h1>
<p>The following example shows how you can build and start the Device Client with Provisioning using Secure Element feature enabled. In this example, we will use SoftHSM2 for storing private key.</p>
<h2><a class="anchor" id="autotoc_md53"></a>
Building Device Client</h2>
<p>The following commands should work for most users when you plan to run the AWS IoT Device Client on the same machine that you're performing the compilation on:</p>
<div class="fragment"><div class="line"># Building</div>
<div class="line">git clone https://github.com/awslabs/aws-iot-device-client</div>
<div class="line">cd aws-iot-device-client</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DEXCLUDE_SECURE_ELEMENT=&quot;OFF&quot; ../</div>
<div class="line">cmake --build . --target aws-iot-device-client</div>
<div class="line"> </div>
<div class="line"># Setup</div>
<div class="line">cd ../</div>
<div class="line">./setup.sh # At this point you&#39;ll need to respond to prompts for information, including paths to your thing certs</div>
</div><!-- fragment --><p><b>Note:</b> You can use <code>EXCLUDE_SECURE_ELEMENT</code> cmake option for including or excluding Secure Element feature from binary build. Default value of this flag is set to <code>ON</code>.</p>
<div class="fragment"><div class="line"># Building</div>
<div class="line">...</div>
<div class="line">cmake -DEXCLUDE_SECURE_ELEMENT=&quot;OFF&quot; ../</div>
<div class="line">...</div>
</div><!-- fragment --><p><b>Note:</b> If you decide not to use <code>setup.sh</code> script, they can manually update the JSON config file or use CLI commands to set the secure element config parameters as shown above.</p>
<h2><a class="anchor" id="autotoc_md54"></a>
Configure SoftHSM2 and start Device Client</h2>
<p>In this example, we will use SoftHSM2 for storing private key.</p>
<ol type="1">
<li>Create an IoT Thing with a certificate and key if you haven't already.</li>
<li>Convert the private key into PKCS#8 format:</li>
</ol>
<div class="fragment"><div class="line">openssl pkcs8 -topk8 -in &lt;private.pem.key&gt; -out &lt;private.p8.key&gt; -nocrypt</div>
</div><!-- fragment --><ol type="1">
<li><p class="startli">Install SoftHSM2:</p>
<p class="startli">``` apt install softhsm </p><div class="fragment"><div class="line">4. Check that it&#39;s working:</div>
</div><!-- fragment --><p> softhsm2-util &ndash;show-slots </p><div class="fragment"><div class="line">If this spits out an error message, create a config file:</div>
<div class="line"> </div>
<div class="line">* Default location: ~/.config/softhsm2/softhsm2.conf</div>
<div class="line">* This file must specify a valid token directory:</div>
</div><!-- fragment --><p> directories.tokendir = /path/for/my/softhsm/tokens/ ```</p><ul>
<li>This file must specify a valid token directory:</li>
<li>Export the location of the config file using the <code>SOFTHSM2_CONF</code></li>
</ul>
</li>
</ol>
<div class="fragment"><div class="line">export SOFTHSM2_CONF=/path/to/config/softhsm2.conf</div>
</div><!-- fragment --><ol type="1">
<li><p class="startli">Create token and import private key.</p>
<p class="startli">You can use any values for the labels, PINs, etc</p>
<p class="startli">``` softhsm2-util &ndash;init-token &ndash;free &ndash;label &lt;token-label&gt; &ndash;pin &lt;user-pin&gt; &ndash;so-pin &lt;so-pin&gt; </p><div class="fragment"><div class="line">Note which slot the token ended up in</div>
</div><!-- fragment --><p> softhsm2-util &ndash;import &lt;private.p8.key&gt; &ndash;slot &lt;slot-with-token&gt; &ndash;label &lt;key-label&gt; &ndash;id &lt;hex-chars&gt; &ndash;pin &lt;user-pin&gt; </p><div class="fragment"><div class="line">8. Now you can run the sample:</div>
</div><!-- fragment --> </li>
</ol>
<h1><a class="anchor" id="autotoc_md55"></a>
Run the AWS IoT Device Client</h1>
<p>./aws-iot-device-client # This command runs the executable ```</p>
<p><b>Note:</b> If you decide not to use <code>setup.sh</code> script, they can manually update the JSON config file or use CLI commands to set the secure element config parameters as shown above.</p>
<h2><a class="anchor" id="autotoc_md56"></a>
Security Best Practices</h2>
<p>Mentioned bellow are the recommended security best practices for using the Device Client. We recommend you to follow these to avoid any security risks.</p>
<ol type="1">
<li>The AWS IoT Device Client requires specific permissions on files and directory storing these files. Please make sure the required permissions are applied on files and directories which are created manually by user before starting the Device Client.</li>
<li>The AWS IoT Device Client's Secure Element feature requires user to install and pass valid PKCS#11 (Cryptoki) library file to the client. The minimum version of PKCS#11 API (Cryptoki) library supported by Device Client is v2.20. Please make sure the library version is or above the minimum requirement of v2.20.</li>
<li>To avoid unauthorized access to the private key file, please make sure the file stored in security module should not be user extractable.</li>
</ol>
<p><a href="#secure-element-access-using-pkcs11"><em>Back To The Top</em></a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
